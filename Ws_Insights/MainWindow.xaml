<Window x:Class="Ws_Insights.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="01_Verax.SW"
        Width="1400"
        Height="860"
        Background="{DynamicResource WindowBackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
        <Style x:Key="MetricCard" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource PanelBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Margin" Value="6" />
        </Style>
        <Style x:Key="MetricTitle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource TextMutedBrush}" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>
        <Style x:Key="MetricValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="24" />
            <Setter Property="FontWeight" Value="Bold" />
        </Style>
        <Style x:Key="SortableHeader" TargetType="GridViewColumnHeader">
            <Setter Property="Foreground" Value="{DynamicResource TerminalTextBrush}" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Background" Value="{DynamicResource TerminalBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource TerminalBackgroundBrush}" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
            <EventSetter Event="Click" Handler="OnGridHeaderClick" />
        </Style>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="30" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- Sidebar -->
        <Border Grid.Column="0"
                Width="{Binding SidebarWidth}"
                Background="{DynamicResource PanelBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="{Binding SidebarBorderThickness}"
                CornerRadius="14"
                Padding="18"
                ClipToBounds="True">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel >
                    <DockPanel>
                        <StackPanel Orientation="Vertical" DockPanel.Dock="Left">
                            <TextBlock Text="01 VERAX.SW" FontSize="26" FontWeight="Bold" />
                            <TextBlock Text="Control maestro de búsqueda" Foreground="{DynamicResource TextMutedBrush}"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Right">
                            <Button x:Name="ThemeButton"
                                    Width="36"
                                    Height="36"
                                    Content="{Binding ThemeGlyph}"
                                    FontSize="16"
                                    Background="{DynamicResource AccentMutedBrush}"
                                    Margin="0,0,8,0"
                                    Click="OnToggleTheme"
                                    ToolTip="Cambiar tema"/>
                            <Button Content="⚙"
                                    Width="36"
                                    Height="36"
                                    Background="{DynamicResource AccentMutedBrush}"
                                    Click="OnManageExtensions"
                                    ToolTip="Administrar extensiones"/>
                        </StackPanel>
                    </DockPanel>

                    <StackPanel>
                        <TextBlock Text="Carpeta base" />
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     MinWidth="260"
                                     Text="{Binding RootPath, UpdateSourceTrigger=PropertyChanged}"
                                     Background="{DynamicResource InputBackgroundBrush}"
                                     BorderBrush="{DynamicResource InputBorderBrush}"
                                     Foreground="{DynamicResource TextBrush}"/>
                            <Button Grid.Column="1"
                                    Content="…"
                                    Width="36"
                                    Click="OnBrowseClick"
                                    ToolTip="Seleccionar carpeta"/>
                        </Grid>
                    </StackPanel>

                    <StackPanel>
                        <TextBlock Text="Texto a buscar" />
                        <TextBox Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}"
                                 Background="{DynamicResource InputBackgroundBrush}"
                                 BorderBrush="{DynamicResource InputBorderBrush}"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal">
                        <CheckBox Content="Mayúsculas"
                                  IsChecked="{Binding CaseSensitive}"
                                  Margin="0,0,10,0"
                                  ToolTip="Distingue entre mayúsculas y minúsculas al buscar"/>
                        <CheckBox Content="Regex"
                                  IsChecked="{Binding UseRegex}"
                                  Margin="0,0,10,0"
                                  ToolTip="Interpreta el texto como una expresión regular"/>
                        <CheckBox Content="Palabra completa"
                                  IsChecked="{Binding WholeWord}"
                                  ToolTip="Coincide solo palabras completas (desactivado si usas regex)"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal">
                        <CheckBox Content="Subcarpetas"
                                  IsChecked="{Binding IncludeSubfolders}"/>
                        <CheckBox Content="Ocultos"
                                  IsChecked="{Binding IncludeHidden}"
                                  Margin="10,0,0,0"/>
                        <CheckBox Content="Sistema"
                                  IsChecked="{Binding IncludeSystem}"
                                  Margin="10,0,0,0"/>
                    </StackPanel>

                    <StackPanel>
                        <TextBlock Text="Extensiones activas" />
                        <Border Background="{DynamicResource InputBackgroundBrush}"
                                BorderBrush="{DynamicResource InputBorderBrush}"
                                BorderThickness="1"
                                Padding="8"
                                CornerRadius="6">
                            <TextBlock Text="{Binding ExtensionSummary}" TextWrapping="Wrap"/>
                        </Border>
                    </StackPanel>

                    <StackPanel>
                        <DockPanel>
                            <TextBlock Text="Hilos paralelos" />
                            <TextBlock DockPanel.Dock="Right" Text="{Binding MaxParallelism}"/>
                        </DockPanel>
                        <Slider Minimum="1"
                                Maximum="{Binding MaxParallelismCeiling}"
                                Value="{Binding MaxParallelism, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel>
                        <DockPanel>
                            <TextBlock Text="Tamaño mínimo (MB)" />
                            <TextBlock DockPanel.Dock="Right" Text="{Binding MinFileSizeMb, StringFormat={}{0:0} MB}"/>
                        </DockPanel>
                        <Slider Minimum="0"
                                Maximum="512"
                                Value="{Binding MinFileSizeMb, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel>
                        <DockPanel>
                            <TextBlock Text="Tamaño máximo (MB)" />
                            <TextBlock DockPanel.Dock="Right" Text="{Binding MaxFileSizeMb, StringFormat={}{0:0} MB}"/>
                        </DockPanel>
                        <Slider Minimum="10"
                                Maximum="4096"
                                Value="{Binding MaxFileSizeMb, Mode=TwoWay}"/>
                        <TextBlock Text="Valores altos pueden requerir más memoria" Foreground="{DynamicResource TextMutedBrush}" FontSize="11"/>
                    </StackPanel>

                    <StackPanel>
                        <DockPanel>
                            <TextBlock Text="Tamaño de fuente de resultados" />
                            <TextBlock DockPanel.Dock="Right" Text="{Binding ResultFontSize, StringFormat={}{0:0}}"/>
                        </DockPanel>
                        <Slider Minimum="10" Maximum="18" Value="{Binding ResultFontSize, Mode=TwoWay}"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal">
                        <Button x:Name="StartButton"
                                Content="Iniciar"
                                Width="90"
                                Margin="0,0,10,0"
                                Click="OnStartSearch"/>
                        <Button x:Name="PauseButton"
                                Content="{Binding PauseButtonText}"
                                Width="90"
                                IsEnabled="False"
                                Margin="0,0,10,0"
                                Click="OnPauseOrResume"/>
                        <Button x:Name="StopButton"
                                Content="Detener"
                                Width="90"
                                IsEnabled="False"
                                Click="OnStopSearch"/>
                    </StackPanel>

                    <StackPanel Orientation="Horizontal">
                        <Button x:Name="ExportButton"
                                Content="Exportar CSV"
                                Width="120"
                                IsEnabled="False"
                                Margin="0,0,10,0"
                                Click="OnExportResults"/>
                        <Button x:Name="MarkdownButton"
                                Content="Exportar Markdown"
                                Width="150"
                                IsEnabled="False"
                                Click="OnExportMarkdown"/>
                    </StackPanel>

                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Collapse button -->
        <Button Grid.Column="1"
                Width="26"
                Content="{Binding SidebarToggleGlyph}"
                Background="{DynamicResource AccentMutedBrush}"
                Click="OnToggleSidebar"
                ToolTip="Mostrar/Ocultar panel"/>

        <!-- Main content -->
        <Grid Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="220" />
            </Grid.RowDefinitions>

            <UniformGrid Grid.Row="0" Rows="2" Columns="3" Margin="0,0,0,6">
                <Border Style="{StaticResource MetricCard}">
                    <StackPanel>
                        <TextBlock Text="ESCANEADOS" Style="{StaticResource MetricTitle}"/>
                        <TextBlock Text="{Binding FilesScanned}" Style="{StaticResource MetricValue}"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCard}">
                    <StackPanel>
                        <TextBlock Text="COINCIDENCIAS" Style="{StaticResource MetricTitle}"/>
                        <TextBlock Text="{Binding Matches}" Style="{StaticResource MetricValue}"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCard}">
                    <StackPanel>
                        <TextBlock Text="ERRORES" Style="{StaticResource MetricTitle}"/>
                        <TextBlock Text="{Binding Errors}" Style="{StaticResource MetricValue}"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCard}">
                    <StackPanel>
                        <TextBlock Text="VELOCIDAD" Style="{StaticResource MetricTitle}"/>
                        <TextBlock Text="{Binding Throughput, StringFormat={}{0:F1} f/s}" Style="{StaticResource MetricValue}"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCard}">
                    <StackPanel>
                        <TextBlock Text="TIEMPO" Style="{StaticResource MetricTitle}"/>
                        <TextBlock Text="{Binding ElapsedDisplay}" Style="{StaticResource MetricValue}"/>
                    </StackPanel>
                </Border>
                <Border Style="{StaticResource MetricCard}">
                    <StackPanel>
                        <TextBlock Text="HILOS ACTIVOS" Style="{StaticResource MetricTitle}"/>
                        <TextBlock Text="{Binding MaxParallelism}" Style="{StaticResource MetricValue}"/>
                    </StackPanel>
                </Border>
            </UniformGrid>

            <Border Grid.Row="1"
                    Background="{DynamicResource PanelBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="10"
                    Padding="12"
                    Margin="0,0,0,10">
                <ScrollViewer HorizontalScrollBarVisibility="Hidden"
                              VerticalScrollBarVisibility="Disabled">
                    <TextBlock Text="{Binding CurrentFile, StringFormat=Procesando: {0}}"
                               TextWrapping="NoWrap"
                               TextTrimming="CharacterEllipsis"
                               Foreground="{DynamicResource TextBrush}"
                               FontWeight="SemiBold"/>
                </ScrollViewer>
            </Border>

            <Border Grid.Row="2"
                    Background="{DynamicResource TerminalBackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="1"
                    CornerRadius="12"
                    Padding="10">
                <ListView x:Name="ResultsList"
                          ItemsSource="{Binding Results}"
                          FontSize="{Binding ResultFontSize}"
                          Background="{DynamicResource TerminalBackgroundBrush}"
                          Foreground="{DynamicResource TerminalTextBrush}"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          MouseDoubleClick="OnOpenSelectedFile"
                          KeyDown="OnResultsKeyDown">
                    <ListView.Resources>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{DynamicResource TerminalTextBrush}"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListViewItem">
                                        <Border Background="{TemplateBinding Background}"
                                                SnapsToDevicePixels="True">
                                            <ContentPresenter HorizontalAlignment="Stretch"
                                                              VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource AccentMutedBrush}"/>
                                    <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource AccentMutedBrush}"/>
                                    <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.Resources>
                    <ListView.View>
                        <GridView AllowsColumnReorder="True">
                            <GridViewColumn Width="240" DisplayMemberBinding="{Binding Name}">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Nombre" Tag="Name" Style="{StaticResource SortableHeader}" />
                                </GridViewColumn.Header>
                            </GridViewColumn>
                            <GridViewColumn Width="70" DisplayMemberBinding="{Binding Extension}">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Ext" Tag="Extension" Style="{StaticResource SortableHeader}" />
                                </GridViewColumn.Header>
                            </GridViewColumn>
                            <GridViewColumn Width="120" DisplayMemberBinding="{Binding SizeKilobytes}">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Tamaño (KB)" Tag="SizeBytes" Style="{StaticResource SortableHeader}" />
                                </GridViewColumn.Header>
                            </GridViewColumn>
                            <GridViewColumn Width="420">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Ruta" Tag="FullPath" Style="{StaticResource SortableHeader}" />
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FullPath}" TextWrapping="Wrap" Foreground="{DynamicResource TerminalTextBrush}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                            <GridViewColumn Width="320">
                                <GridViewColumn.Header>
                                    <GridViewColumnHeader Content="Fragmento" Tag="Snippet" Style="{StaticResource SortableHeader}" />
                                </GridViewColumn.Header>
                                <GridViewColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Snippet}" TextWrapping="Wrap" Foreground="{DynamicResource TerminalTextBrush}"/>
                                    </DataTemplate>
                                </GridViewColumn.CellTemplate>
                            </GridViewColumn>
                        </GridView>
                    </ListView.View>
                    <ListView.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Abrir archivo" Click="OnOpenSelectedFile"/>
                            <MenuItem Header="Mostrar en carpeta" Click="OnRevealInExplorer"/>
                            <MenuItem Header="Copiar ruta" Click="OnCopyPath"/>
                        </ContextMenu>
                    </ListView.ContextMenu>
                </ListView>
            </Border>

            <Border Grid.Row="3" Background="{DynamicResource LogBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="12" Padding="10">
                <DockPanel>
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" HorizontalAlignment="Right">
                        <Button Content="Copiar" Click="OnCopyLog" Margin="0,0,10,0"/>
                        <Button Content="Limpiar" Click="OnClearLog"/>
                    </StackPanel>
                    <ListBox ItemsSource="{Binding LogEntries}"
                             FontFamily="Cascadia Code"
                             FontSize="13"
                             Background="{DynamicResource LogBackgroundBrush}"
                             Foreground="{DynamicResource LogTextBrush}"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             ScrollViewer.HorizontalScrollBarVisibility="Auto">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <VirtualizingStackPanel />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                    </ListBox>
                </DockPanel>
            </Border>
        </Grid>
    </Grid>
</Window>



