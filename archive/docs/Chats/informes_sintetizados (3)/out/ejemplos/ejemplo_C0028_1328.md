```powershell
# --- CREA New-FileMap.GUI.v6.ps1 EN TU CARPETA ---
$dstDir = 'C:\Users\VictorFabianVeraVill\Desktop\PowerShell'
$dst    = Join-Path $dstDir 'New-FileMap.GUI.v6.ps1'
if (-not (Test-Path -LiteralPath $dstDir)) { New-Item -ItemType Directory -Path $dstDir -Force | Out-Null }

$code = @'
<#
New-FileMap.GUI.v6.ps1 — CSV + Analizador
Cambios v6:
- Selector Windows para carpeta/archivo en “Ruta raíz”.
- Mejor separación visual entre secciones.
- Tema oscuro real (textboxes/combos/numerics oscuros).
- Relanzamiento automático en STA si hace falta (diálogos siempre funcionan).
- Mapeo simple (recursivo, ocultos, exclusión por extensiones), hash opcional (SHA256/SHA1/SHA384/SHA512).
#>

[CmdletBinding(SupportsShouldProcess=$true)]
param()

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

# --- Asegurar STA para diálogos ---
if ([System.Threading.Thread]::CurrentThread.ApartmentState -ne 'STA') {
  $exe = (Get-Process -Id $PID).Path
  & $exe -NoProfile -ExecutionPolicy Bypass -STA -File $PSCommandPath
  exit
}

# ---------- Utils ----------
function Get-DesktopPath { try { [Environment]::GetFolderPath('Desktop') } catch { Join-Path $env:USERPROFILE 'Desktop' } }
function NowStamp { (Get-Date -Format 'yyyyMMdd_HHmmss') }
function Ensure-Dir([string]$p){ if (-not (Test-Path -LiteralPath $p)) { New-Item -ItemType Directory -Path $p | Out-Null } }
function CsvEscape([string]$s){ if ($null -eq $s) { return '""' }; '"' + ($s -replace '"','""') + '"' }
function ToIso([datetime]$d){ if ($null -eq $d) { "" } else { $d.ToString("s") } }
function Simple-MimeByExt([string]$ext){
  if ([string]::IsNullOrWhiteSpace($ext)) { return "" }
  $e = $ext.ToLowerInvariant().TrimStart('.')
  $map = @{
    'txt'='text/plain'; 'md'='text/markdown'; 'csv'='text/csv'; 'json'='application/json'; 'xml'='application/xml';
    'pdf'='application/pdf'; 'doc'='application/msword'; 'docx'='application/vnd.openxmlformats-officedocument.wordprocessingml.document';
    'xls'='application/vnd.ms-excel'; 'xlsx'='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
    'ppt'='application/vnd.ms-powerpoint'; 'pptx'='application/vnd.openxmlformats-officedocument.presentationml.presentation';
    'jpg'='image/jpeg'; 'jpeg'='image/jpeg'; 'png'='image/png'; 'gif'='image/gif'; 'bmp'='image/bmp'; 'webp'='image/webp';
    'zip'='application/zip'; '7z'='application/x-7z-compressed'; 'rar'='application/vnd.rar';
    'exe'='application/vnd.microsoft.portable-executable'; 'dll'='application/x-msdownload';
    'ps1'='text/x-powershell'; 'py'='text/x-python'; 'js'='text/javascript'; 'html'='text/html';
  }
  return $map[$e]
}
function Compute-Hash([string]$path,[string]$alg='SHA256'){
  try { (Get-FileHash -LiteralPath $path -Algorithm $alg -ErrorAction Stop).Hash.ToLowerInvariant() } catch { "" }
}
function Ensure-Under-Users([string]$path){
  $allowed = [System.IO.Path]::GetFullPath('C:\Users\')
  $full = [System.IO.Path]::GetFullPath($path)
  return $full.StartsWith($allowed, [System.StringComparison]::OrdinalIgnoreCase)
}
function Atomic-WriteCsv([string]$dest,[string[]]$lines){
  $dir = Split-Path -Path $dest -Parent; Ensure-Dir $dir
  $tmp = "$dest.tmp"; $bak = "$dest.bak"
  if (Test-Path -LiteralPath $dest) { try { Move-Item -LiteralPath $dest -Destination $bak -Force -ErrorAction Stop } catch {} }
  $enc = New-Object System.Text.UTF8Encoding($false)
  $sw = New-Object System.IO.StreamWriter($tmp,$false,$enc)
  foreach($ln in $lines){ $sw.WriteLine($ln) }
  $sw.Flush(); $sw.Dispose()
  Move-Item -LiteralPath $tmp -Destination $dest -Force
  return $dest
}
function File-Sha256([string]$path){
  try { (Get-FileHash -LiteralPath $path -Algorithm SHA256 -ErrorAction Stop).Hash.ToLowerInvariant() } catch { "" }
}
function Get-TopFolder([string]$root,[string]$full){
  $rel = [System.IO.Path]::GetRelativePath($root,$full) -replace '/','\'
  if ($rel -eq '.' -or [string]::IsNullOrWhiteSpace($rel)) { return '' }
  $parts = $rel.Split('\'); if ($parts.Length -gt 0) { return $parts[0] } else { return '' }
}
function Get-ParentRel([string]$rel){
  $rel = $rel.TrimEnd('\'); $idx = $rel.LastIndexOf('\'); if ($idx -ge 0) { return $rel.Substring(0,$idx) } else { return '' }
}

# ---------- Mapping ----------
function New-FileMapCsv {
  [CmdletBinding()]
  param(
    [Parameter(Mandatory)][string]$RootPath,
    [Parameter(Mandatory)][string]$OutDir,
    [switch]$IncludeHidden,
    [switch]$Recurse,
    [string[]]$ExcludeExt = @('.tmp','.log','.bak','.map','.pyc','.class'),
    [int]$BlockSize=5000,
    [int]$ProgressEvery=500,
    [switch]$ComputeHash,
    [ValidateSet('SHA256','SHA1','SHA384','SHA512')][string]$HashAlgorithm='SHA256'
  )
  if (-not (Test-Path -LiteralPath $RootPath)) { throw "No existe la ruta: $RootPath" }
  Ensure-Dir $OutDir

  $ts = NowStamp
  $rootName = Split-Path -Path $RootPath -Leaf; if ([string]::IsNullOrWhiteSpace($rootName)) { $rootName = ($RootPath -replace '[:\\\/]','_') }
  $csvPath = Join-Path $OutDir ("FileList_{0}_{1}.csv" -f ($rootName -replace '[^\w\.-]','_'), $ts)

  $items = @()
  $it = Get-Item -LiteralPath $RootPath -ErrorAction Stop
  if ($it.PSIsContainer) {
    $gci = @{ LiteralPath=$RootPath; File=$true; ErrorAction='SilentlyContinue'; Force=$true }
    if ($Recurse) { $gci['Recurse']=$true }
    $items = @(Get-ChildItem @gci -Force)
  } else {
    $items = @($it)  # archivo único
  }

  function Pass([System.IO.FileSystemInfo]$fi){
    if (-not $IncludeHidden) {
      if ($fi.Attributes.HasFlag([IO.FileAttributes]::Hidden) -or $fi.Attributes.HasFlag([IO.FileAttributes]::System)) { return $false }
    }
    if ($fi.PSIsContainer) { return $false }
    $ext = $fi.Extension.ToLowerInvariant()
    if ($ExcludeExt -and ($ExcludeExt -contains $ext)) { return $false }
    return $true
  }

  $items = @($items | Where-Object { Pass $_ })
  $headers = @('relpath','name','ext','is_dir','size_bytes','mtime_iso','ctime_iso','atime_iso','mime','sha256','depth','top','parent')
  $lines = @(); $lines += ($headers -join ',')
  $total = $items.Count; $processed = 0

  foreach ($batch in $items | ForEach-Object -Begin { $buf=@() } -Process {
      $buf += $_; if ($buf.Count -ge $BlockSize) { ,$buf; $buf=@() }
    } -End { if ($buf.Count){ ,$buf } }) {

    foreach ($fi in $batch) {
      $processed++
      if (($processed % [Math]::Max(1,$ProgressEvery)) -eq 0 -or $processed -eq $total) {
        $pct = if ($total){ [int](($processed/$total)*100) } else { 100 }
        Write-Progress -Activity 'Mapeando' -Status "$processed / $total" -PercentComplete $pct
      }
      $full = $fi.FullName
      $base = if ($it.PSIsContainer) { $RootPath } else { Split-Path -Parent $RootPath }
      $rel  = [System.IO.Path]::GetRelativePath($base,$full) -replace '/','\'
      if ([string]::IsNullOrWhiteSpace($rel)) { $rel='.' }
      $name = $fi.Name
      $ext  = $fi.Extension.ToLowerInvariant().TrimStart('.')
      $isDir = $false
      $size = [int64]$fi.Length
      $mtime = ToIso($fi.LastWriteTime)
      $ctime = ToIso($fi.CreationTime)
      $atime = ToIso($fi.LastAccessTime)
      $mime  = Simple-MimeByExt $ext
      $sha   = if ($ComputeHash) { Compute-Hash $full $HashAlgorithm } else { "" }
      $depth = ($rel -split '\\').Length - 1
      $top   = if ($it.PSIsContainer) { Get-TopFolder $RootPath $full } else { '' }
      $parent= Get-ParentRel $rel

      $line = @(
        CsvEscape $rel; CsvEscape $name; CsvEscape $ext; "$isDir"; "$size"; CsvEscape $mtime; CsvEscape $ctime; CsvEscape $atime;
        CsvEscape $mime; CsvEscape $sha; "$depth"; CsvEscape $top; CsvEscape $parent
      ) -join ','
      $lines += $line
    }
  }

  $final = Atomic-WriteCsv $csvPath $lines
  Write-Progress -Activity 'Mapeando' -Completed
  Write-Host "CSV generado: $final"
  $shaCsv = File-Sha256 $final
  if ($shaCsv) { Write-Host "SHA-256(CSV): $shaCsv" }
  return @{ Csv=$final; Count=$items.Count }
}

# ---------- Acciones ----------
function UniqueDest([string]$dir,[string]$name){
  $t=Join-Path $dir $name; if (-not (Test-Path -LiteralPath $t)) { return $t }
  $stem=[System.IO.Path]::GetFileNameWithoutExtension($name); $ext=[System.IO.Path]::GetExtension($name); $i=1
  while($true){ $cand=Join-Path $dir ("{0} ({1}){2}" -f $stem,$i,$ext); if(-not (Test-Path -LiteralPath $cand)){return $cand}; $i++ }
}
function Action-Move-DuplicatesByHash {
  param(
    [Parameter(Mandatory)][object[]]$Rows,
    [Parameter(Mandatory)][string]$DestRoot,
    [ValidateSet('OldestMtime','Alphabetical')][string]$KeepBy = 'OldestMtime'
  )
  if (-not (Ensure-Under-Users $DestRoot)) { throw "Acciones SOLO dentro de C:\Users\ (destino: $DestRoot)" }
  Ensure-Dir $DestRoot
  $groups = $Rows | Where-Object { $_.sha256 } | Group-Object sha256
  foreach($g in $groups){
    $items = @($g.Group | Where-Object { $_.relpath -and $_.name -and $_.sha256 } )
    if ($items.Count -le 1) { continue }
    $groupDir = Join-Path $DestRoot $g.Name; Ensure-Dir $groupDir
    $keeper = if ($KeepBy -eq 'Alphabetical') { ($items | Sort-Object relpath)[0] } else { ($items | Sort-Object mtime_iso)[0] }
    foreach($it in $items){
      if ($it -eq $keeper) { continue }
      $srcFull = Join-Path $global:__lastRoot $it.relpath
      if (-not (Ensure-Under-Users $srcFull)) { Write-Host "[SKIP] $srcFull fuera de C:\Users\"; continue }
      if (-not (Test-Path -LiteralPath $srcFull)) { continue }
      $dest = UniqueDest -dir $groupDir -name $it.name
      try { Move-Item -LiteralPath $srcFull -Destination $dest -Force -ErrorAction Stop; Write-Host "[MOVIDO] $srcFull -> $dest" }
      catch { Write-Host "[ERROR] $($_.Exception.Message)" -ForegroundColor Red }
    }
  }
  Write-Host "Destino: $DestRoot"
}

# ---------- Analizador (strings/metadata) ----------
Add-Type -AssemblyName System.Runtime
try { [System.Text.Encoding]::RegisterProvider([System.Text.CodePagesEncodingProvider]::Instance) } catch {}

function Extract-AsciiStrings {
  param([byte[]]$Bytes,[int]$MinLen=6)
  $buf = New-Object System.Collections.Generic.List[object]
  $start = -1; $i=0; $n=$Bytes.Length
  while($i -lt $n){
    $b = $Bytes[$i]
    $is = ($b -ge 0x20 -and $b -le 0x7E) -or ($b -in 0x09,0x0A,0x0D)
    if ($is){ if ($start -lt 0){ $start=$i } }
    else {
      if ($start -ge 0){
        $len = $i - $start
        if ($len -ge $MinLen){
          $text = [System.Text.Encoding]::ASCII.GetString($Bytes,$start,$len)
          $buf.Add([pscustomobject]@{ offset=$start; byte_len=$len; text=$text; encoding='ascii' })
        }
        $start=-1
      }
    }
    $i++
  }
  if ($start -ge 0){
    $len = $n - $start
    if ($len -ge $MinLen){
      $text = [System.Text.Encoding]::ASCII.GetString($Bytes,$start,$len)
      $buf.Add([pscustomobject]@{ offset=$start; byte_len=$len; text=$text; encoding='ascii' })
    }
  }
  return @($buf)
}
function Extract-CP936Strings {
  param([byte[]]$Bytes,[int]$MinChars=4)
  $enc = [System.Text.Encoding]::GetEncoding(936)
  $res = New-Object System.Collections.Generic.List[object]
  $i=0; $n=$Bytes.Length
  while($i -lt $n-1){
    $b1=$Bytes[$i]; $b2=$Bytes[$i+1]
    $isLead = ($b1 -ge 0x81 -and $b1 -le 0xFE)
    $isTrail= ($b2 -ge 0x40 -and $b2 -le 0xFE -and $b2 -ne 0x7F)
    if ($isLead -and $isTrail){
      $start=$i; $pairs=0
      while($i -lt $n-1){
        $x1=$Bytes[$i]; $x2=$Bytes[$i+1]
        if (($x1 -ge 0x81 -and $x1 -le 0xFE) -and ($x2 -ge 0x40 -and $x2 -le 0xFE -and $x2 -ne 0x7F)){
          $pairs += 1; $i += 2
        } else { break }
      }
      if ($pairs -ge $MinChars){
        $len = $i - $start
        $text = $enc.GetString($Bytes, $start, $len)
        $res.Add([pscustomobject]@{ offset=$start; byte_len=$len; text=$text; encoding='cp936' })
      }
    } else { $i++ }
  }
  return @($res)
}
function Classify-String([string]$text,[string]$enc){
  if ($enc -eq 'cp936'){ return 'state/zh' }
  if ($text -match '[A-Za-z]{4,}') { return 'state/en' }
  if ($text -match '0x[0-9A-Fa-f]{2,}') { return 'constant/pattern' }
  return 'string/heuristic'
}
function Run-Analyzer {
  [CmdletBinding(SupportsShouldProcess=$true)]
  param(
    [Parameter(Mandatory)][string]$Target,   # archivo o carpeta
    [switch]$Recurse,
    [int]$AsciiMin=6,
    [int]$CP936Min=4,
    [string]$OutDir,
    [switch]$DryRun
  )
  if (-not (Test-Path -LiteralPath $Target)) { throw "No existe: $Target" }
  if (-not $OutDir) { $OutDir = Join-Path (Split-Path -Parent $PSCommandPath) "_out/ysd-catalog" }
  Ensure-Dir $OutDir
  $ts = NowStamp
  $csv = Join-Path $OutDir "ysd-catalog_{0}.csv" -f $ts

  $paths = @()
  $item = Get-Item -LiteralPath $Target
  if ($item.PSIsContainer){
    $filter = @{ LiteralPath=$Target; File=$true; ErrorAction='SilentlyContinue'; Force=$true }
    if ($Recurse){ $filter['Recurse']=$true }
    $paths = @(Get-ChildItem @filter | Where-Object { $_.Extension -match '\.(exe|ysd|dcy)$' })
  } else {
    if ($item.Extension -match '\.(exe|ysd|dcy)$'){ $paths=@($item) } else { throw "El archivo no coincide con *.exe;*.ysd;*.dcy" }
  }
  $rows = New-Object System.Collections.Generic.List[string]
  $headers = 'file_path,relpath,name,ext,size_bytes,sha256,encoding,offset,byte_len,classifier,text,timestamp'
  $rows.Add($headers)

  foreach($f in $paths){
    try { $bytes = [System.IO.File]::ReadAllBytes($f.FullName) }
    catch { Write-Warning "No se pudo leer: $($f.FullName) ($($_.Exception.Message))"; continue }
    $sha = File-Sha256 $f.FullName
    $ascii = Extract-AsciiStrings -Bytes $bytes -MinLen $AsciiMin
    $cp936 = Extract-CP936Strings -Bytes $bytes -MinChars $CP936Min
    foreach($s in @($ascii + $cp936)){
      $cls = Classify-String $s.text $s.encoding
      $rel = if ($item.PSIsContainer) { [System.IO.Path]::GetRelativePath($Target,$f.FullName) } else { [System.IO.Path]::GetFileName($f.FullName) }
      $rel = $rel -replace '/','\'
      $line = @(
        CsvEscape $f.FullName; CsvEscape $rel; CsvEscape $f.Name; CsvEscape ($f.Extension.TrimStart('.').ToLowerInvariant());
        "$($f.Length)"; CsvEscape $sha; CsvEscape $s.encoding; "$($s.offset)"; "$($s.byte_len)"; CsvEscape $cls;
        CsvEscape ($s.text.Substring(0,[Math]::Min($s.text.Length,600))); CsvEscape (Get-Date -Format 's')
      ) -join ','
      $rows.Add($line)
    }
  }

  if ($DryRun){
    Write-Host "DryRun: no se escribirá CSV. Candidatos: $($rows.Count-1)"
    return @{ Csv=$csv; Candidates=$rows.Count-1 }
  }
  $final = Atomic-WriteCsv $csv $rows
  $shaCsv = File-Sha256 $final
  Write-Host "CSV analizador: $final"
  if ($shaCsv){ Write-Host "SHA-256(CSV): $shaCsv" }
  $preview = Get-Content -LiteralPath $final -TotalCount 11
  Write-Host "Primeras filas:"; $preview | ForEach-Object { Write-Host $_ }
  return @{ Csv=$final; Count=$rows.Count-1 }
}

# ---------- GUI ----------
Add-Type -AssemblyName System.Windows.Forms | Out-Null
Add-Type -AssemblyName System.Drawing | Out-Null

# Theme helpers
function Apply-Theme([System.Windows.Forms.Control]$ctrl,[string]$mode){
  $dark = ($mode -eq 'Dark')
  $bg  = if ($dark) { [System.Drawing.Color]::FromArgb(18,18,18) } else { [System.Drawing.SystemColors]::Control }
  $fg  = if ($dark) { [System.Drawing.Color]::White } else { [System.Drawing.Color]::Black }
  $tb  = if ($dark) { [System.Drawing.Color]::FromArgb(32,32,32) } else { [System.Drawing.Color]::White }
  $btn = if ($dark) { [System.Drawing.Color]::FromArgb(45,45,45) } else { [System.Drawing.SystemColors]::Control }
  $ctrl.BackColor=$bg; $ctrl.ForeColor=$fg
  foreach($c in $ctrl.Controls){
    try {
      $c.ForeColor=$fg
      switch ($true) {
        { $c -is [System.Windows.Forms.TextBox] }       { $c.BackColor=$tb; $c.BorderStyle='FixedSingle' }
        { $c -is [System.Windows.Forms.ComboBox] }      { $c.BackColor=$tb; $c.FlatStyle='Flat' }
        { $c -is [System.Windows.Forms.NumericUpDown] } { $c.BackColor=$tb; $c.BorderStyle='FixedSingle' }
        { $c -is [System.Windows.Forms.Button] }        { $c.BackColor=$btn; $c.FlatStyle='Flat'; $c.FlatAppearance.BorderColor=$fg }
        default {}
      }
    } catch {}
    if ($c.Controls.Count -gt 0) { Apply-Theme $c $mode }
  }
}
function Browse-Folder(){ $fb=New-Object System.Windows.Forms.FolderBrowserDialog; if($fb.ShowDialog() -eq 'OK'){ return $fb.SelectedPath } return $null }
function Browse-File($filter="Todos|*.*"){ $fd=New-Object System.Windows.Forms.OpenFileDialog; $fd.Filter=$filter; if($fd.ShowDialog() -eq 'OK'){ return $fd.FileName } return $null }

$form = New-Object System.Windows.Forms.Form
$form.Text = "New-FileMap v6 (CSV + Analizador)"
$form.WindowState = 'Maximized'
$form.Font = New-Object System.Drawing.Font("Segoe UI",9)

# Tema
$lblTheme = New-Object System.Windows.Forms.Label; $lblTheme.Text="Tema:"; $lblTheme.Left=12; $lblTheme.Top=12; $lblTheme.AutoSize=$true
$ddTheme = New-Object System.Windows.Forms.ComboBox; $ddTheme.Left=60; $ddTheme.Top=8; $ddTheme.Width=120; $ddTheme.DropDownStyle='DropDownList'; @('Light','Dark') | % { [void]$ddTheme.Items.Add($_) }; $ddTheme.SelectedItem='Light'
$form.Controls.AddRange(@($lblTheme,$ddTheme))

# --- Sección 1 ---
$gb1 = New-Object System.Windows.Forms.GroupBox
$gb1.Text = "1) FileMap → CSV"
$gb1.Left=10; $gb1.Top=40; $gb1.Width=1280; $gb1.Height=240; $gb1.Anchor='Top,Left,Right'

# Entrada: Carpeta/Archivo
$lblMode = New-Object System.Windows.Forms.Label; $lblMode.Text="Entrada:"; $lblMode.Left=15; $lblMode.Top=28; $lblMode.AutoSize=$true
$rbFolder = New-Object System.Windows.Forms.RadioButton; $rbFolder.Text="Carpeta"; $rbFolder.Left=75; $rbFolder.Top=26; $rbFolder.AutoSize=$true; $rbFolder.Checked=$true
$rbFile   = New-Object System.Windows.Forms.RadioButton; $rbFile.Text="Archivo"; $rbFile.Left=150; $rbFile.Top=26; $rbFile.AutoSize=$true

# Ruta raíz
$lblRoot = New-Object System.Windows.Forms.Label; $lblRoot.Text="Ruta raíz:"; $lblRoot.Left=15; $lblRoot.Top=55; $lblRoot.AutoSize=$true
$tbRoot = New-Object System.Windows.Forms.TextBox; $tbRoot.Left=80; $tbRoot.Top=52; $tbRoot.Width=1020; $tbRoot.ReadOnly=$true; $tbRoot.Anchor='Top,Left,Right'
$btnRoot = New-Object System.Windows.Forms.Button; $btnRoot.Text="Examinar..."; $btnRoot.Left=1105; $btnRoot.Top=50; $btnRoot.Width=150; $btnRoot.Anchor='Top,Right'
$btnRoot.Add_Click({
  if ($rbFile.Checked) { $p=Browse-File "Todos|*.*"; if($p){ $tbRoot.Text=$p } }
  else { $p=Browse-Folder; if($p){ $tbRoot.Text=$p } }
})

# Salida
$lblOut = New-Object System.Windows.Forms.Label; $lblOut.Text="Salida en:"; $lblOut.Left=15; $lblOut.Top=85; $lblOut.AutoSize=$true
$tbOut = New-Object System.Windows.Forms.TextBox; $tbOut.Left=80; $tbOut.Top=82; $tbOut.Width=1020; $tbOut.ReadOnly=$true; $tbOut.Anchor='Top,Left,Right'; $tbOut.Text=Get-DesktopPath
$btnOut = New-Object System.Windows.Forms.Button; $btnOut.Text="Examinar..."; $btnOut.Left=1105; $btnOut.Top=80; $btnOut.Width=150; $btnOut.Anchor='Top,Right'
$btnOut.Add_Click({ $p=Browse-Folder; if($p){ $tbOut.Text=$p } })

# Opciones
$cbHidden = New-Object System.Windows.Forms.CheckBox; $cbHidden.Text="Incluir ocultos/Sistema"; $cbHidden.Left=20; $cbHidden.Top=115; $cbHidden.AutoSize=$true
$cbRecur  = New-Object System.Windows.Forms.CheckBox; $cbRecur.Text="Recursivo"; $cbRecur.Left=200; $cbRecur.Top=115; $cbRecur.AutoSize=$true; $cbRecur.Checked=$true
$cbRecur.Add_CheckedChanged({ if ($rbFile.Checked) { $cbRecur.Checked=$false } })
$rbFile.Add_CheckedChanged({ if ($rbFile.Checked){ $cbRecur.Checked=$false } })

$lblBlock = New-Object System.Windows.Forms.Label; $lblBlock.Text="BlockSize:"; $lblBlock.Left=320; $lblBlock.Top=116; $lblBlock.AutoSize=$true
$numBlock = New-Object System.Windows.Forms.NumericUpDown; $numBlock.Left=385; $numBlock.Top=112; $numBlock.Width=80; $numBlock.Minimum=100; $numBlock.Maximum=500000; $numBlock.Value=5000
$lblProg  = New-Object System.Windows.Forms.Label; $lblProg.Text="Progreso cada:"; $lblProg.Left=480; $lblProg.Top=116; $lblProg.AutoSize=$true
$numProg  = New-Object System.Windows.Forms.NumericUpDown; $numProg.Left=570; $numProg.Top=112; $numProg.Width=80; $numProg.Minimum=50; $numProg.Maximum=1000000; $numProg.Value=500

# Hash
$cbHash = New-Object System.Windows.Forms.CheckBox; $cbHash.Text="Hash"; $cbHash.Left=670; $cbHash.Top=115; $cbHash.AutoSize=$true
$lblAlg  = New-Object System.Windows.Forms.Label; $lblAlg.Text="Algoritmo:"; $lblAlg.Left=725; $lblAlg.Top=116; $lblAlg.AutoSize=$true
$ddAlg   = New-Object System.Windows.Forms.ComboBox; $ddAlg.Left=790; $ddAlg.Top=112; $ddAlg.Width=120; $ddAlg.DropDownStyle='DropDownList'; @('SHA256','SHA1','SHA384','SHA512') | % { [void]$ddAlg.Items.Add($_) }; $ddAlg.SelectedItem='SHA256'

# Exclusiones (diálogo con checks)
$lblExc = New-Object System.Windows.Forms.Label; $lblExc.Text="Excluir extensiones:"; $lblExc.Left=20; $lblExc.Top=145; $lblExc.AutoSize=$true
$txtExc = New-Object System.Windows.Forms.TextBox; $txtExc.Left=130; $txtExc.Top=142; $txtExc.Width=970; $txtExc.ReadOnly=$true; $txtExc.Anchor='Top,Left,Right'
$btnExc = New-Object System.Windows.Forms.Button; $btnExc.Text="Configurar..."; $btnExc.Left=1105; $btnExc.Top=140; $btnExc.Width=150; $btnExc.Anchor='Top,Right'
$commonExt = @('.tmp','.log','.bak','.map','.pyc','.class','.7z','.rar','.iso','.dll','.obj','.pdb')
$selectedExt = @('.tmp','.log','.bak','.map','.pyc','.class')
$txtExc.Text = ($selectedExt -join ',')
$btnExc.Add_Click({
  $dlg = New-Object System.Windows.Forms.Form
  $dlg.Text="Exclusiones"; $dlg.Width=420; $dlg.Height=420; $dlg.StartPosition='CenterParent'
  $clb = New-Object System.Windows.Forms.CheckedListBox; $clb.Left=10; $clb.Top=10; $clb.Width=380; $clb.Height=300; $clb.CheckOnClick=$true
  foreach($e in $commonExt){ [void]$clb.Items.Add($e, ($selectedExt -contains $e)) }
  $lblCustom = New-Object System.Windows.Forms.Label; $lblCustom.Text="Personalizadas (.ext separadas por coma):"; $lblCustom.Left=10; $lblCustom.Top=320; $lblCustom.AutoSize=$true
  $tbCustom = New-Object System.Windows.Forms.TextBox; $tbCustom.Left=10; $tbCustom.Top=340; $tbCustom.Width=380
  $btnOK = New-Object System.Windows.Forms.Button; $btnOK.Text='Aceptar'; $btnOK.Left=220; $btnOK.Top=370; $btnOK.Width=80
  $btnCancel = New-Object System.Windows.Forms.Button; $btnCancel.Text='Cancelar'; $btnCancel.Left=310; $btnCancel.Top=370; $btnCancel.Width=80
  $btnOK.Add_Click({
    $sel=@(); foreach($i in 0..($clb.Items.Count-1)){ if($clb.GetItemChecked($i)){ $sel += [string]$clb.Items[$i] } }
    if ($tbCustom.Text.Trim()){
      $extra = $tbCustom.Text.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ }
      $sel += $extra
    }
    $script:selectedExt = $sel | Select-Object -Unique
    $dlg.DialogResult=[System.Windows.Forms.DialogResult]::OK; $dlg.Close()
  })
  $btnCancel.Add_Click({ $dlg.DialogResult=[System.Windows.Forms.DialogResult]::Cancel; $dlg.Close() })
  $dlg.Controls.AddRange(@($clb,$lblCustom,$tbCustom,$btnOK,$btnCancel))
  [void]$dlg.ShowDialog($form)
  $txtExc.Text = ($selectedExt -join ',')
})

# Acciones principales
$btnMap = New-Object System.Windows.Forms.Button; $btnMap.Text="Mapear → CSV"; $btnMap.Left=20; $btnMap.Top=175; $btnMap.Width=180; $btnMap.Height=32
$btnOpen= New-Object System.Windows.Forms.Button; $btnOpen.Text="Abrir carpeta de salida"; $btnOpen.Left=210; $btnOpen.Top=175; $btnOpen.Width=190; $btnOpen.Height=32; $btnOpen.Enabled=$false

$pb = New-Object System.Windows.Forms.ProgressBar; $pb.Left=20; $pb.Top=212; $pb.Width=1235; $pb.Height=18; $pb.Minimum=0; $pb.Maximum=100; $pb.Anchor='Top,Left,Right'

$gb1.Controls.AddRange(@($lblMode,$rbFolder,$rbFile,$lblRoot,$tbRoot,$btnRoot,$lblOut,$tbOut,$btnOut,
  $cbHidden,$cbRecur,$lblBlock,$numBlock,$lblProg,$numProg,$cbHash,$lblAlg,$ddAlg,$lblExc,$txtExc,$btnExc,$btnMap,$btnOpen,$pb))
$form.Controls.Add($gb1)

# --- Sección 2 (con mejor margen) ---
$gb2 = New-Object System.Windows.Forms.GroupBox
$gb2.Text = "2) Acciones (seguras en C:\Users\)"
$gb2.Left=10; $gb2.Top=($gb1.Top + $gb1.Height + 16); $gb2.Width=1280; $gb2.Height=140; $gb2.Anchor='Top,Left,Right'

$btnLoad = New-Object System.Windows.Forms.Button; $btnLoad.Text="Cargar CSV..."; $btnLoad.Left=20; $btnLoad.Top=30; $btnLoad.Width=160; $btnLoad.Height=32
$btnDup  = New-Object System.Windows.Forms.Button; $btnDup.Text="Mover duplicados (hash)"; $btnDup.Left=190; $btnDup.Top=30; $btnDup.Width=190; $btnDup.Height=32; $btnDup.Enabled=$false

$lblDest = New-Object System.Windows.Forms.Label; $lblDest.Text="Destino acciones:"; $lblDest.Left=390; $lblDest.Top=36; $lblDest.AutoSize=$true
$tbDest = New-Object System.Windows.Forms.TextBox; $tbDest.Left=500; $tbDest.Top=33; $tbDest.Width=635; $tbDest.ReadOnly=$true; $tbDest.Anchor='Top,Left,Right'; $tbDest.Text=(Join-Path (Get-DesktopPath) 'Duplicates_SHA256')
$btnDest = New-Object System.Windows.Forms.Button; $btnDest.Text="Examinar..."; $btnDest.Left=1140; $btnDest.Top=31; $btnDest.Width=150; $btnDest.Anchor='Top,Right'
$btnDest.Add_Click({ $p=Browse-Folder; if($p){ $tbDest.Text=$p } })

$gb2.Controls.AddRange(@($btnLoad,$btnDup,$lblDest,$tbDest,$btnDest))
$form.Controls.Add($gb2)

# --- Sección 3 ---
$gb3 = New-Object System.Windows.Forms.GroupBox
$gb3.Text = "3) Analizador de binarios (strings/metadata)"
$gb3.Left=10; $gb3.Top=($gb2.Top + $gb2.Height + 16); $gb3.Width=1280; $gb3.Height=150; $gb3.Anchor='Top,Left,Right'

$lblObj = New-Object System.Windows.Forms.Label; $lblObj.Text="Objetivo:"; $lblObj.Left=15; $lblObj.Top=32; $lblObj.AutoSize=$true
$tbXT = New-Object System.Windows.Forms.TextBox; $tbXT.Left=75; $tbXT.Top=29; $tbXT.Width=880; $tbXT.ReadOnly=$true; $tbXT.Anchor='Top,Left,Right'
$btnXTFile = New-Object System.Windows.Forms.Button; $btnXTFile.Text="Archivo..."; $btnXTFile.Left=965; $btnXTFile.Top=27; $btnXTFile.Width=120; $btnXTFile.Anchor='Top,Right'
$btnXTDir  = New-Object System.Windows.Forms.Button; $btnXTDir.Text="Carpeta...";  $btnXTDir.Left=1090; $btnXTDir.Top=27; $btnXTDir.Width=120; $btnXTDir.Anchor='Top,Right'
$btnXTFile.Add_Click({ $p=Browse-File "EXE/YSD/DCY|*.exe;*.ysd;*.dcy|Todos|*.*"; if($p){ $tbXT.Text=$p } })
$btnXTDir.Add_Click({ $p=Browse-Folder; if($p){ $tbXT.Text=$p } })

$cbRecX = New-Object System.Windows.Forms.CheckBox; $cbRecX.Text="Recurse (subcarpetas)"; $cbRecX.Left=75; $cbRecX.Top=62; $cbRecX.AutoSize=$true; $cbRecX.Checked=$true
$lblAM = New-Object System.Windows.Forms.Label; $lblAM.Text="ASCII min:"; $lblAM.Left=230; $lblAM.Top=64; $lblAM.AutoSize=$true
$numAM = New-Object System.Windows.Forms.NumericUpDown; $numAM.Left=290; $numAM.Top=60; $numAM.Width=60; $numAM.Minimum=1; $numAM.Maximum=200; $numAM.Value=6
$lblCM = New-Object System.Windows.Forms.Label; $lblCM.Text="CP936 min:"; $lblCM.Left=360; $lblCM.Top=64; $lblCM.AutoSize=$true
$numCM = New-Object System.Windows.Forms.NumericUpDown; $numCM.Left=430; $numCM.Top=60; $numCM.Width=60; $numCM.Minimum=1; $numCM.Maximum=200; $numCM.Value=4
$cbDry = New-Object System.Windows.Forms.CheckBox; $cbDry.Text="Dry-run (no escribe CSV)"; $cbDry.Left=500; $cbDry.Top=62; $cbDry.AutoSize=$true

$btnRunX = New-Object System.Windows.Forms.Button; $btnRunX.Text="Ejecutar analizador → CSV"; $btnRunX.Left=75; $btnRunX.Top=95; $btnRunX.Width=220; $btnRunX.Height=32

$gb3.Controls.AddRange(@($lblObj,$tbXT,$btnXTFile,$btnXTDir,$cbRecX,$lblAM,$numAM,$lblCM,$numCM,$cbDry,$btnRunX))
$form.Controls.Add($gb3)

# --- Estado / Tema ---
$global:__lastRows = @(); $global:__lastRoot = ""
$ddTheme.Add_SelectedIndexChanged({ Apply-Theme $form $ddTheme.SelectedItem })
Apply-Theme $form $ddTheme.SelectedItem

# --- Wire: Mapear ---
$btnMap.Add_Click({
  if (-not (Test-Path -LiteralPath $tbRoot.Text)) { [System.Windows.Forms.MessageBox]::Show("Selecciona Ruta raíz (carpeta o archivo)."); return }
  if (-not (Test-Path -LiteralPath $tbOut.Text))  { [System.Windows.Forms.MessageBox]::Show("Selecciona carpeta de salida."); return }
  foreach($c in $form.Controls){ try { $c.Enabled=$false } catch{} }
  try {
    $res = New-FileMapCsv -RootPath $tbRoot.Text.Trim() -OutDir $tbOut.Text.Trim() `
           -IncludeHidden:$cbHidden.Checked -Recurse:$cbRecur.Checked `
           -ExcludeExt $selectedExt -BlockSize $numBlock.Value -ProgressEvery $numProg.Value `
           -ComputeHash:$cbHash.Checked -HashAlgorithm $ddAlg.SelectedItem
    $base = (Get-Item -LiteralPath $tbRoot.Text).PSIsContainer ? $tbRoot.Text : (Split-Path -Parent $tbRoot.Text)
    $global:__lastRoot = $base
    $global:__lastRows = @(Import-Csv -LiteralPath $res.Csv -Encoding UTF8)
    $btnOpen.Enabled=$true
    $btnDup.Enabled=($global:__lastRows | ? { $_.sha256 } | Measure-Object).Count -gt 0
    [System.Windows.Forms.MessageBox]::Show("CSV generado:`n$($res.Csv)`nFilas: $($res.Count)")
  } catch { [System.Windows.Forms.MessageBox]::Show($_.Exception.Message) }
  foreach($c in $form.Controls){ try { $c.Enabled=$true } catch{} }
})
$btnOpen.Add_Click({ if ($tbOut.Text) { Start-Process explorer.exe $tbOut.Text } })

# --- Wire: Acciones ---
function Browse-CSV(){ Browse-File "CSV|*.csv|Todos|*.*" }
$btnLoad.Add_Click({
  $f = Browse-CSV; if ($f) {
    try { $global:__lastRows = @(Import-Csv -LiteralPath $f -Encoding UTF8); $btnDup.Enabled=($global:__lastRows | ? { $_.sha256 } | Measure-Object).Count -gt 0 }
    catch { [System.Windows.Forms.MessageBox]::Show($_.Exception.Message) }
  }
})
$btnDup.Add_Click({
  try {
    if ($global:__lastRows.Count -eq 0) { [System.Windows.Forms.MessageBox]::Show("No hay datos cargados."); return }
    if (-not (Ensure-Under-Users $tbDest.Text)) { [System.Windows.Forms.MessageBox]::Show("Acciones limitadas a C:\Users\. Cambia el destino."); return }
    Action-Move-DuplicatesByHash -Rows $global:__lastRows -DestRoot $tbDest.Text.Trim() -KeepBy 'OldestMtime'
    [System.Windows.Forms.MessageBox]::Show("Duplicados movidos a:`n$($tbDest.Text)")
  } catch { [System.Windows.Forms.MessageBox]::Show($_.Exception.Message) }
})

# --- Wire: Analizador ---
$btnRunX.Add_Click({
  try {
    $target = if ($tbXT.Text) { $tbXT.Text } else { $tbRoot.Text }
    if (-not (Test-Path -LiteralPath $target)) { [System.Windows.Forms.MessageBox]::Show("Define Objetivo del analizador."); return }
    $res = Run-Analyzer -Target $target -Recurse:$cbRecX.Checked -AsciiMin $numAM.Value -CP936Min $numCM.Value -DryRun:$cbDry.Checked
    [System.Windows.Forms.MessageBox]::Show("Analizador completado.`nCSV: $($res.Csv)")
  } catch { [System.Windows.Forms.MessageBox]::Show($_.Exception.Message) }
})

[void]$form.ShowDialog()
return
'@

# Guardar UTF-8 sin BOM y desbloquear
$utf8NoBom = New-Object System.Text.UTF8Encoding($false)
[System.IO.File]::WriteAllText($dst, $code, $utf8NoBom)
try { Unblock-File -LiteralPath $dst } catch {}
Write-Host "✔ Archivo creado en: $dst"
Write-Host "Para ejecutar:  pwsh -ExecutionPolicy Bypass -File `"$dst`""
```