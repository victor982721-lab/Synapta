```text
function Write-Log {
  [CmdletBinding()]
  param(
    [Parameter(Mandatory)][ValidateSet('Info','Warn','Error','DryRun','Debug','Verbose')]
    [string]$Level,
    [Parameter(Mandatory)][ValidateNotNullOrEmpty()][string]$Message,
    [switch]$NoFile
  )

  $msg = [string]$Message
  $msgOneline = ($msg -replace '\s+', ' ').Trim()
  $prefix = switch ($Level) {
    'Info'    { '[INFO] ' }
    'Warn'    { '[WARN] ' }
    'Error'   { '[ERROR] ' }
    'DryRun'  { '[DRY-RUN] ' }
    'Debug'   { '[DEBUG] ' }
    'Verbose' { '[VERBOSE] ' }
  }
  $text = "$prefix$msg"

  # ---------- File logging (intentar SIEMPRE antes de lanzar error)
  $shouldFileLog = $false
  try {
    if (-not $NoFile -and $Global:InitConfig `
        -and ($Global:InitConfig.PSObject.Properties.Name -contains 'LogToFile') `
        -and $Global:InitConfig.LogToFile `
        # Si quieres registrar también en DryRun, quita esta línea:
        #-and -not $Global:IsDryRun
    ) { $shouldFileLog = $true }

    if ($shouldFileLog) {
      if (-not $Global:ExecTS) { $Global:ExecTS = [DateTime]::UtcNow.ToString('yyyyMMdd_HHmmssfff') }
      $verifyDir = if ($Global:InitConfig.PSObject.Properties.Name -contains 'VerifyDir') { $Global:InitConfig.VerifyDir } else { $null }
      if ($verifyDir) {
        if (-not (Test-Path -LiteralPath $verifyDir)) { New-Item -ItemType Directory -Path $verifyDir -Force | Out-Null }
        $logFile = Join-Path $verifyDir "init_$($Global:ExecTS).log"
        $ts = (Get-Date).ToUniversalTime().ToString('s') + 'Z'
        Add-Content -LiteralPath $logFile -Value ("{0} {1}{2}" -f $ts, $prefix, $msgOneline) -Encoding utf8
      }
    }
  } catch { }

  # ---------- Salida por streams nativos (sin Write-Host)
  switch ($Level) {
    'Info' {
      # Forzar visibilidad de Information solo dentro de esta llamada
      $prev = $InformationPreference
      try { $script:InformationPreference = 'Continue'; Write-Information $text -Tags 'INFO' }
      finally { $script:InformationPreference = $prev }
    }
    'Warn'    { Write-Warning $msg }
    'Error'   {
      if ($Global:IsDryRun) {
        # En Prueba NO detenemos
        Write-Error $msg -ErrorAction Continue
      } else {
        # En Real detenemos
        Write-Error $msg -ErrorAction Stop
      }
    }
    'DryRun'  {
      $prev = $InformationPreference
      try { $script:InformationPreference = 'Continue'; Write-Information "[DRY-RUN] $msg" -Tags 'DRYRUN' }
      finally { $script:InformationPreference = $prev }
    }
    'Debug'   { Write-Debug $text }
    'Verbose' { Write-Verbose $text }
  }
}
```